version: 1
applications:
  - appRoot: playground          # ← 必须是字符串，并且和 frontend 同层
    frontend:
      env:
        NODE_OPTIONS: '--max-old-space-size=16384'

      phases:
        preBuild:
          commands:
            - echo "NODE_OPTIONS=$NODE_OPTIONS"
            - node -e "const v8=require('v8');console.log('Heap limit:',v8.getHeapStatistics().heap_size_limit/2**20,'MB')"
            - node --version
            - corepack enable pnpm@10.13.1
            - pnpm install --frozen-lockfile --child-concurrency=1 --workspace-concurrency=1
        build:
          commands:
            - pnpm --filter @advjs/types            --workspace-concurrency=1 run build
            - pnpm --filter @advjs/parser           --workspace-concurrency=1 run build
            - pnpm --filter @advjs/core             --workspace-concurrency=1 run build
            - pnpm --filter advjs                   --workspace-concurrency=1 run build
            - pnpm --filter @advjs/plugin-pominis   --workspace-concurrency=1 run build
            - pnpm --filter @advjs/playground       --workspace-concurrency=1 run build

      artifacts:
        baseDirectory: playground/dist
        files:
          - '**/*'

      cache:                  # 彻底关闭环境缓存，防止脏层
        disabled: true


