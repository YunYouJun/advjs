<script setup lang="ts">
import { computed, ref, watchEffect } from 'vue'
import { useElementSize } from '@vueuse/core'
import { advAspect, advHeight, advWidth, configs } from '~/env'

const props = defineProps<{
  width?: number
  meta?: any
  scale?: number | string
}>()

const root = ref<HTMLDivElement>()
const element = useElementSize(root)

const width = computed(() => (props.width ? props.width : element.width.value))
const height = computed(() =>
  props.width ? props.width / advAspect : element.height.value,
)

if (props.width) {
  watchEffect(() => {
    if (root.value) {
      root.value.style.width = `${width.value}px`
      root.value.style.height = `${height.value}px`
    }
  })
}

const screenAspect = computed(() => width.value / height.value)

const scale = computed(() => {
  if (props.scale)
    return props.scale
  if (screenAspect.value < advAspect)
    return width.value / advWidth
  return (height.value * advAspect) / advWidth
})

const style = computed(() => ({
  transform: `translate(-50%, -50%) scale(${scale.value})`,
}))

const containerStyles = computed(() => {
  return {
    '--adv-container-width': `${advWidth}px`,
    '--adv-container-height': `${advHeight}px`,
  }
})

const className = computed(() => ({
  'select-none': !configs.selectable,
}))
</script>

<template>
  <div ref="root" class="adv-container relative overflow-hidden" :class="className" :style="containerStyles">
    <div id="adv-content" :style="style">
      <slot />
    </div>
    <slot name="controls" />
  </div>
</template>

<style lang="scss">
// #adv-container will be hidden by adblock plugin
.adv-container {
  background: var(--adv-container-bg, var(--adv-c-bg));
}

#adv-content {
  @apply relative overflow-hidden absolute left-1/2 top-1/2;

  width: var(--adv-container-width);
  height: var(--adv-container-height);
}
</style>
